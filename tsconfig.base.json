unsafeWindow.GmAjax = GM_xmlhttpRequest;
 
(function() {
 
    'use strict';
 
var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();
 
function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }
 
var FetchUserjs = function () {
    function FetchUserjs() {
        _classCallCheck(this, FetchUserjs);
 
        this.host = this.getMainHost();
        this.showTime = 10;
        this.quietKey = 'jae_fetch_userjs_quiet';
        this.countKey = 'jae_fetch_userjs_count';
        this.tplBox = '<div id="jae_userscript_box"><style>.jae-userscript{position:fixed;width:370px;bottom:10px;right:20px;z-index:9999999999;height:56px}.jae-userscript-shadow{box-shadow:0 1px 4px rgba(0,0,0,.3),\\t\\t\\t\\t0px 0 20px rgba(0,0,0,.1) inset}.jae-userscript-shadow::before,.jae-userscript-shadow::after{content:"";position:absolute;z-index:-1}.jae-userscript-shadow::before,.jae-userscript-shadow::after{content:"";position:absolute;z-index:-1;bottom:15px;left:10px;width:50%;height:20%}.jae-userscript-shadow::before,.jae-userscript-shadow::after{content:"";position:absolute;z-index:-1;bottom:15px;left:10px;width:50%;height:20%;box-shadow:0 15px 10px rgba(0,0,0,.7);transform:rotate(-3deg)}.jae-userscript-shadow::after{right:10px;left:auto;transform:rotate(3deg)}</style><div class="jae-userscript" class=""></div></div>';
    }
 
    _createClass(FetchUserjs, [{
        key: 'getMainHost',
        value: function getMainHost() {
            var host = window.location.hostname;
            return psl.get(host) || host.split('.').splice(-2).join('.');
        }
    }, {
        key: 'getCountData',
        value: function getCountData(host) {
            var countData = GM_getResourceText('count');
            countData = JSON.parse(countData);
            var count = countData[host];
            sessionStorage.setItem(this.countKey, count);
            return count;
        }
    }, {
        key: 'setSize',
        value: function setSize(w, h) {
            $('.jae-userscript').css({
                width: w,
                height: h
            });
        }
    }, {
        key: 'addEventListener',
        value: function addEventListener(eventName, handler) {
            document.getElementById('jae_userscript_box').addEventListener(eventName, handler);
        }
    }, {
        key: 'bindEvent',
        value: function bindEvent() {
            var _this = this;
 
            this.timeId = setTimeout(function () {
                $('#jae_userscript_box').remove();
            }, this.showTime * 1000);
 
            this.addEventListener('max', function () {
                _this.setSize(860, 492);
                $('.jae-userscript').addClass('jae-userscript-shadow');
                clearTimeout(_this.timeId);
            });
 
            this.addEventListener('min', function () {
                setTimeout(function () {
                    $('.jae-userscript').removeClass('jae-userscript-shadow');
                    _this.setSize(370, 56);
                }, 500);
            });
 
            this.addEventListener('close', function () {
                sessionStorage.setItem(_this.quietKey, 1);
                $('#jae_userscript_box').remove();
            });
 
            this.addEventListener('loading', function () {
                clearTimeout(_this.timeId);
            });
        }
    }, {
        key: 'execFrameJs',
        value: function execFrameJs(frameWindow) {
            var uiJs = GM_getResourceText('uiJs');
            return function (jsStr) {
                frameWindow.eval(jsStr);
            }.call(frameWindow, uiJs);
        }
    }, {
        key: 'render',
        value: function render() {
            if (!this.isQuiet) {
                var count = this.getCountData(this.host);
                if (count) {
                    $('body').append(this.tplBox);
 
                    var ui = GM_getResourceText('ui');
                    var dom = document.getElementsByClassName('jae-userscript')[0];
                    var tpl = '<iframe name="jaeFetchUserJSFrame" src="about:blank" style="width:100%;height:100%;border:0px;display: block!important;" allowTransparency="true"></iframe>';
                    dom.innerHTML = tpl;
                    var iframeDom = dom.children[0];
                    iframe.write(iframeDom, ui);
 
                    this.execFrameJs(jaeFetchUserJSFrame.window);
 
                    this.bindEvent();
                }
            }
        }
    }, {
        key: 'isQuiet',
        get: function get() {
            var quiet = sessionStorage.getItem(this.quietKey);
            return quiet ? true : false;
        }
    }]);
 
    return FetchUserjs;
}();
 
ljs.exec(['jQuery', 'iframe', 'psl'], function () {
    var fu = new FetchUserjs();
    fu.render();
});
 
})();